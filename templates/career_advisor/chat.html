{% extends 'base.html' %}

{% block title %}AI Career Chat - Sahay AI{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="text-center mb-4">
            <i class="fas fa-comments"></i> AI Career Chat
        </h2>
        <p class="text-center lead">Ask me anything about your career, skills, or job search!</p>
        
        {% if rag_available %}
        <div class="alert alert-success text-center">
            <i class="fas fa-robot"></i> <strong>AI-Powered Chat:</strong> Your resume has been analyzed and I can provide personalized career advice!
        </div>
        {% else %}
        <div class="alert alert-info text-center">
            <i class="fas fa-info-circle"></i> <strong>Basic Chat:</strong> Using predefined career guidelines
        </div>
        {% endif %}
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="feature-card">
            <div class="chat-container" id="chatContainer">
                <div class="message bot-message">
                    <strong>AI Career Mentor:</strong> 
                    {% if rag_available %}
                    Hello! I'm your AI career advisor. I've analyzed your resume and can provide personalized career advice based on your background. What would you like to know?
                    {% else %}
                    Hello! I'm your career advisor. I can help you with general career questions and guidance. What would you like to know?
                    {% endif %}
                </div>
            </div>
            
            <form id="chatForm" class="mt-3">
                {% csrf_token %}
                <div class="input-group">
                    <input type="text" id="questionInput" class="form-control" placeholder="Ask about your career, skills, or job search..." required>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
            </form>
            
            <div class="mt-3">
                <small class="text-muted">
                    <i class="fas fa-lightbulb"></i> 
                    {% if rag_available %}
                    Try asking: "What skills should I focus on for Data Science?", "How can I improve my resume?", "What career paths suit my background?"
                    {% else %}
                    Try asking: "What skills should I focus on?", "How can I improve my resume?", "What career paths suit my background?"
                    {% endif %}
                </small>
            </div>
        </div>
        
        <div class="feature-card mt-4">
            <h5><i class="fas fa-info-circle"></i> What I Can Help With</h5>
            <div class="row">
                <div class="col-md-6">
                    <ul>
                        <li>Skills gap analysis</li>
                        <li>Career path suggestions</li>
                        <li>Resume improvement tips</li>
                        <li>Interview preparation</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <ul>
                        <li>Learning recommendations</li>
                        <li>Job search strategies</li>
                        <li>Industry insights</li>
                        <li>Salary guidance</li>
                    </ul>
                </div>
            </div>
        </div>
        
        {% if rag_available %}
        <div class="feature-card mt-3">
            <h5><i class="fas fa-robot text-primary"></i> AI Features Available</h5>
            <ul>
                <li><strong>Personalized Analysis:</strong> Based on your actual resume content</li>
                <li><strong>Context-Aware Responses:</strong> Understands your background and skills</li>
                <li><strong>Semantic Search:</strong> Finds relevant information from your resume</li>
                <li><strong>Intelligent Recommendations:</strong> AI-generated career advice</li>
            </ul>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('chatForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const question = document.getElementById('questionInput').value;
    if (!question.trim()) return;
    
    // Add user message
    addMessage(question, 'user');
    document.getElementById('questionInput').value = '';
    
    // Show typing indicator
    const typingDiv = addTypingIndicator();
    
    // Send to backend
    fetch('{% url "career_advisor:career_chat" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `question=${encodeURIComponent(question)}`
    })
    .then(response => response.json())
    .then(data => {
        // Remove typing indicator
        typingDiv.remove();
        
        // Add AI response
        const responseText = data.answer || 'I apologize, but I couldn\'t generate a response.';
        addMessage(responseText, 'bot', data.rag_used);
    })
    .catch(error => {
        // Remove typing indicator
        typingDiv.remove();
        
        // Add error message
        addMessage('Sorry, there was an error processing your request. Please try again.', 'bot', false);
        console.error('Error:', error);
    });
});

function addMessage(text, sender, ragUsed = false) {
    const container = document.getElementById('chatContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    
    const senderName = sender === 'user' ? 'You' : 'AI Career Mentor';
    let icon = '';
    
    if (sender === 'bot' && ragUsed) {
        icon = ' <i class="fas fa-robot text-primary" title="AI-Powered Response"></i>';
    }
    
    messageDiv.innerHTML = `<strong>${senderName}:</strong>${icon} ${text}`;
    
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}

function addTypingIndicator() {
    const container = document.getElementById('chatContainer');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message bot-message typing-indicator';
    typingDiv.innerHTML = '<strong>AI Career Mentor:</strong> <i class="fas fa-ellipsis-h"></i> Thinking...';
    
    container.appendChild(typingDiv);
    container.scrollTop = container.scrollHeight;
    
    return typingDiv;
}

// Add some sample questions for quick access
function addSampleQuestion(question) {
    document.getElementById('questionInput').value = question;
    document.getElementById('questionInput').focus();
}

// Add sample questions to the page
document.addEventListener('DOMContentLoaded', function() {
    const sampleQuestions = [
        "What skills should I focus on for Data Science?",
        "How can I improve my resume?",
        "What career paths suit my background?",
        "What should I learn next?"
    ];
    
    const container = document.querySelector('.feature-card');
    if (container) {
        const sampleDiv = document.createElement('div');
        sampleDiv.className = 'mt-3';
        sampleDiv.innerHTML = `
            <h6><i class="fas fa-lightbulb"></i> Quick Questions</h6>
            <div class="d-flex flex-wrap gap-2">
                ${sampleQuestions.map(q => 
                    `<button class="btn btn-sm btn-outline-secondary" onclick="addSampleQuestion('${q}')">${q}</button>`
                ).join('')}
            </div>
        `;
        container.appendChild(sampleDiv);
    }
});
</script>

<style>
.typing-indicator {
    opacity: 0.7;
    font-style: italic;
}

.message {
    margin-bottom: 15px;
    padding: 10px 15px;
    border-radius: 10px;
    max-width: 80%;
}

.user-message {
    background-color: var(--primary-color);
    color: white;
    margin-left: auto;
    text-align: right;
}

.bot-message {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
}

.chat-container {
    max-height: 400px;
    overflow-y: auto;
    padding: 15px;
    border: 1px solid #e9ecef;
    border-radius: 10px;
    background-color: white;
}
</style>
{% endblock %} 